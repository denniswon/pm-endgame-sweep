name: PR Checks

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  pr-metadata:
    name: PR Metadata Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR title format
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|ci)(\(.+\))?: .+'; then
            echo "::warning::PR title doesn't follow conventional commit format"
            echo "::warning::Recommended format: type(scope): description"
            echo "::warning::Example: feat(api): add market filtering endpoint"
          fi

      - name: Check PR size
        run: |
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          LINES_CHANGED=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | grep -oE '[0-9]+ insertions|[0-9]+ deletions' | grep -oE '[0-9]+' | awk '{sum+=$1} END {print sum}')

          echo "Files changed: $FILES_CHANGED"
          echo "Lines changed: $LINES_CHANGED"

          if [ "$FILES_CHANGED" -gt 50 ]; then
            echo "::warning::Large PR detected ($FILES_CHANGED files changed)"
            echo "::warning::Consider splitting into smaller PRs for easier review"
          fi

          if [ "$LINES_CHANGED" -gt 1000 ]; then
            echo "::warning::Large PR detected ($LINES_CHANGED lines changed)"
            echo "::warning::Consider splitting into smaller PRs for easier review"
          fi

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: github.event.pull_request.draft == false

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          allow-licenses: >-
            MIT,
            Apache-2.0,
            BSD-2-Clause,
            BSD-3-Clause,
            ISC,
            0BSD,
            Zlib,
            CC0-1.0,
            BlueOak-1.0.0,
            CDLA-Permissive-2.0,
            Unicode-3.0,
            Unlicense
          allow-dependencies-licenses: >-
            pkg:npm/string-width-cjs@4.2.3,
            pkg:npm/strip-ansi-cjs@6.0.1,
            pkg:npm/wrap-ansi-cjs@7.0.0,
            pkg:cargo/bigdecimal@0.4.10
